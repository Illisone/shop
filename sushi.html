<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>YAKUZA –°—É—à–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body data-theme="dark">
  <div id="slash-container" class="slash-container"></div>
  <!-- –õ–û–ì–û –≤ –æ—Å—Ç—Ä–æ–≤–∫–µ + –ø–æ–∏—Å–∫-–æ—Å—Ç—Ä–æ–≤–æ–∫ + –∞–≤–∞—Ç–∞—Ä -->
  <div class="top-line">
    <div class="logo-island" onclick="showAllCategories()" style="cursor: pointer;">YAKUZA</div>

    <div class="top-right-group">
      <form class="search-form" id="search-form">
        <input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫" class="search-input">
        <button type="button" class="search-btn" id="search-btn"></button>
      </form>

      <div class="user-avatar-wrapper" onclick="openProfile()">
        <img id="user-avatar" class="user-avatar" src="https://via.placeholder.com/100" alt="">
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="hero-slider" id="hero-slider"></div>
    <div id="filter-bar" class="filter-bar"></div>
    <div class="grid" id="grid"></div>
  </div>
  <!-- —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é -->
  <!-- –Ω–∏–∂–Ω–∏–µ —Ç–∞–±—ã -->
<nav class="bottom-tabs">
  <button class="bottom-tab active" onclick="showAllCategories()">
    <span class="bottom-icon">üè†</span>
    <span>–ì–ª–∞–≤–Ω–∞—è</span>
  </button>
  <button class="bottom-tab" onclick="switchTab('rolls')">
    <span class="bottom-icon">üç£</span>
    <span>–†–æ–ª–ª—ã</span>
  </button>
  <button class="bottom-tab" onclick="switchTab('wok')">
    <span class="bottom-icon">üçú</span>
    <span>–í–æ–∫–∏</span>
  </button>
  <button class="bottom-tab" onclick="switchTab('snacks')">
    <span class="bottom-icon">ü•ü</span>
    <span>–ó–∞–∫—É—Å–∫–∏</span>
  </button>
  <button class="bottom-tab" onclick="switchTab('drinks')">
    <span class="bottom-icon">ü•§</span>
    <span>–ù–∞–ø–∏—Ç–∫–∏</span>
  </button>
</nav>

  <!-- –ø–ª–∞–≤–∞—é—â–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
  <div id="mini-cart" onclick="openCart()">
    <span>üõí</span>
    <span id="mini-sum">0‚ÇΩ</span>
  </div>

  <!-- —à—Ç–æ—Ä–∫–∏ -->
  <div class="overlay" id="overlay" onclick="closeAll()"></div>

  <!-- –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞ -->
  <div id="details-sheet" class="sheet">
    <div class="sheet-handle"></div>
    <img id="d-img" style="width:100%;border-radius:22px;height:260px;object-fit:cover;">
    <h2 id="d-title" style="margin:20px 0 5px;font-size:26px;font-weight:900;"></h2>
    <p id="d-meta" style="color:var(--text-gray);font-size:14px;margin-bottom:15px;"></p>
    <p id="d-desc" style="color:#bbb;line-height:1.5;font-size:15px;margin-bottom:20px;"></p>
    <button class="btn-main" onclick="addToCartFromDetails()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
  </div>

  <!-- –∫–æ—Ä–∑–∏–Ω–∞-—à—Ç–æ—Ä–∫–∞ -->
  <div id="cart-sheet" class="sheet">
    <div class="sheet-handle"></div>
    <h2 style="margin:0 0 20px;font-weight:900;">–í–∞—à –∑–∞–∫–∞–∑</h2>
    <div class="sheet-scroll">
      <div id="cart-items"></div>
      <div id="cart-empty" style="text-align:center;padding:30px;color:var(--text-gray);display:none;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
      </div>

      <div class="extras-title">–î–æ–±–∞–≤–∏—Ç—å –∫ –∑–∞–∫–∞–∑—É?</div>
      <div class="extras-grid" id="extras-grid"></div>

      <div class="promo-row">
        <input type="text" class="promo-input" id="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
        <button class="promo-btn" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>

      <div class="pay-selector">
        <div class="pay-opt active" onclick="setPay('cash',this)">–ù–∞–ª–∏—á–Ω—ã–µ</div>
        <div class="pay-opt" onclick="setPay('card',this)">–ö–∞—Ä—Ç–æ–π</div>
        <div class="pay-opt" onclick="setPay('online',this)">–û–Ω–ª–∞–π–Ω</div>
      </div>

      <div class="total-row">
        <span>–ò—Ç–æ–≥–æ</span>
        <span id="total-val">0‚ÇΩ</span>
      </div>
      <div class="delivery-free" id="delivery-free"></div>

      <input type="text" id="address" class="input-style" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" onfocus="focusField(this)">
    </div>
    <button class="btn-main" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

  <!-- –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç -->
  <div id="profile-sheet" class="sheet">
    <div class="sheet-handle"></div>
    <h2 style="margin:0 0 20px;font-weight:900;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
    <div class="sheet-scroll">
      <div class="profile-card">
        <img id="profile-avatar" class="profile-avatar-large" src="https://via.placeholder.com/100" alt="">
        <div class="profile-name" id="profile-name">‚Äî</div>
        <div class="profile-phone" id="profile-phone">‚Äî</div>
        <div class="profile-bonus-card">
          <div class="profile-bonus-label">–ë–æ–Ω—É—Å—ã</div>
          <div class="profile-bonus-val" id="profile-bonus">1 250 ‚ÇΩ</div>

        </div>
      </div>
      <div style="margin-bottom:20px;">
        <div style="font-size:14px;color:var(--text-gray);">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
        <input type="text" id="profile-address" class="input-style" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞">
      </div>
      <div style="margin-top:20px; display: flex; flex-direction: column; gap: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size:14px; color:var(--text-gray);">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
          <label class="theme-switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider theme-slider"></span> <span class="labels">üåô</span>
          </label>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size:14px; color:var(--text-gray);">–í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫</div>
          <label class="theme-switch">
            <input type="checkbox" id="haptic-toggle">
            <span class="slider haptic-slider"></span> <span class="labels">üì≥</span>
          </label>
        </div>
      </div>
    </div>
    <button class="btn-main" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <script>
    /* ----------  —Ç–æ—Ç –∂–µ JS, —á—Ç–æ –±—ã–ª, + –Ω–æ–≤—ã–π –ø–æ–∏—Å–∫-–æ—Å—Ç—Ä–æ–≤–æ–∫  ---------- */
    let tg = window.Telegram.WebApp; tg.expand();
    let showAllMode = true;
    let settings = {
      hapticEnabled: localStorage.getItem('haptic-enabled') !== 'false'
    };
    let cart = [], curProd = null, payMethod = 'cash', currentTab = 'rolls';
    const lastSize = {};
    let promoApplied = false;
    let userData = { name: '‚Äî', phone: '‚Äî', address: '', bonus: 1250 };

    const menu = {
      rolls: [
        { id: 1, name: "–ú–µ—á—Ç–∞ –∫–æ—Ç–∞", price: 1530, meta: "32 —à—Ç | 1.1 –∫–≥", img: "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=600&q=80", desc: "–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è –æ–≥—É—Ä–µ—Ü, –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è –±–µ–∫–æ–Ω, –¢–µ–º–ø—É—Ä–∞ —á–∏–∫–µ–Ω, –¢–µ–º–ø—É—Ä–∞ —Ç–∞–º–∞–≥–æ –ª–æ—Å–æ—Å—å.", tag: "HOT", tagIcon: "üå∂Ô∏è" },
        { id: 2, name: "–°–µ—Ç –ó–∏–º–Ω–∏–π", price: 1945, meta: "64 —à—Ç | 2.2 –∫–≥", img: "https://images.unsplash.com/photo-1583623025817-d180a2221d0a?w=600&q=80", desc: "–û–≥—Ä–æ–º–Ω—ã–π —Å–µ—Ç –¥–ª—è –±–æ–ª—å—à–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.", tag: "NEW", tagIcon: "üî•" },
        { id: 3, name: "–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è", price: 650, meta: "8 —à—Ç | 280 –≥", img: "https://images.unsplash.com/photo-1553621042-f6e147245754?w=600&q=80", desc: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–æ–ª–ª —Å–æ —Å–≤–µ–∂–∏–º –ª–æ—Å–æ—Å–µ–º.", tag: "", tagIcon: "" },
        { id: 4, name: "–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è", price: 590, meta: "8 —à—Ç | 250 –≥", img: "https://images.unsplash.com/photo-1559466273-d95e72debaf8?w=600&q=80", desc: "–°–Ω–µ–∂–Ω—ã–π –∫—Ä–∞–±, –æ–≥—É—Ä–µ—Ü –∏ –∏–∫—Ä–∞ —Ç–æ–±–∏–∫–æ.", tag: "", tagIcon: "" }
      ],
      wok: [
        { id: 5, name: "–ö—É—Ä–∏—Ü–∞ –≤–æ–∫", price: 490, meta: "320 –≥", img: "https://images.unsplash.com/photo-1512058560366-cd2427ff06d3?w=600&q=80", desc: "–ö—É—Ä–∏—Ü–∞, –æ–≤–æ—â–∏, —Å–æ—É—Å —Ç–µ—Ä–∏—è–∫–∏.", tag: "", tagIcon: "" },
        { id: 6, name: "–ì–æ–≤—è–¥–∏–Ω–∞ –≤–æ–∫", price: 590, meta: "320 –≥", img: "https://images.unsplash.com/photo-1543826173-70651703c5a4?w=600&q=80", desc: "–ì–æ–≤—è–¥–∏–Ω–∞, –æ–≤–æ—â–∏, —Å–æ—É—Å —á–∏–ª–∏.", tag: "HOT", tagIcon: "üå∂Ô∏è" }
      ],
      snacks: [
        { id: 7, name: "–ì–µ–¥–∑–∞", price: 290, meta: "6 —à—Ç", img: "https://images.unsplash.com/photo-1617093727343-374698b1b08d?w=600&q=80", desc: "–Ø–ø–æ–Ω—Å–∫–∏–µ –ø–µ–ª—å–º–µ–Ω–∏ —Å –Ω–∞—á–∏–Ω–∫–æ–π –Ω–∞ –≤—ã–±–æ—Ä.", tag: "", tagIcon: "" },
        { id: 8, name: "–°–ø–∞–π—Å–∏ —ç–¥–∞–º–∞–º–µ", price: 190, meta: "120 –≥", img: "https://images.unsplash.com/photo-1609501676725-7186f017a4b7?w=600&q=80", desc: "–ú–æ–ª–æ–¥—ã–µ –±–æ–±—ã —Å –æ—Å—Ç—Ä—ã–º —Å–æ—É—Å–æ–º.", tag: "HOT", tagIcon: "üå∂Ô∏è" }
      ],
      drinks: [
        {
          id: 9, name: "Coca-Cola", price: 120,
          sizes: [{ vol: '0.5 –ª', price: 120 }, { vol: '1 –ª', price: 190 }],
          img: "https://images.unsplash.com/photo-1513558161293-cdaf765ed2fd?w=600&q=80", desc: "–õ–∏–º–æ–Ω, –º—è—Ç–∞, –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π —Å–æ–∫.", meta: "", tag: "", tagIcon: ""
        },
        { id: 10, name: "–§RESH-–ª–∏–º–æ–Ω–∞–¥", price: 180, meta: "0.4 –ª", img: "https://images.unsplash.com/photo-1513558161293-cdaf765ed2fd?w=600&q=80", desc: "–õ–∏–º–æ–Ω, –º—è—Ç–∞, –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π —Å–æ–∫.", tag: "NEW", tagIcon: "üî•" }
      ]
    };

    const extras = [
      { id: 'wasabi', name: '–í–∞—Å–∞–±–∏', price: 30, icon: 'üå∂Ô∏è' },
      { id: 'sticks', name: '–ü–∞–ª–æ—á–∫–∏', price: 40, icon: 'ü•¢' },
      { id: 'soya', name: '–°–æ–µ–≤—ã–π —Å–æ—É—Å', price: 35, icon: 'üßÇ' }
    ];

    const heroImages = [
      { img: "https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=1200&q=80", txt: "–ü–æ–¥–∞—Ä–æ–∫ –∫ –∑–∞–∫–∞–∑—É –æ—Ç 2000‚ÇΩ" },
      { img: "https://images.unsplash.com/photo-1611143669185-af224c5e3252?w=1200&q=80", txt: "–°–∫–∏–¥–∫–∞ -15% –Ω–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑" },
      { img: "https://images.unsplash.com/photo-1553621042-f6e147245754?w=1200&q=80", txt: "–ù–æ–≤—ã–π —Å–µ—Ç ¬´–°–∞–º—É—Ä–∞–π¬ª" }
    ];

    let heroIndex = 0;
    function initHeroSlider() {
      const slider = document.getElementById('hero-slider');
      slider.innerHTML = heroImages.map((h, i) => `
    <div class="hero-slide ${i === 0 ? 'active' : ''}">
      <img src="${h.img}" alt="">
      <div class="hero-text">${h.txt}</div>
    </div>`).join('');
      setInterval(() => {
        const slides = slider.querySelectorAll('.hero-slide');
        slides[heroIndex].classList.remove('active');
        heroIndex = (heroIndex + 1) % slides.length;
        slides[heroIndex].classList.add('active');
      }, 3000);
    }
    let scrollBeforeDetail = 0; // –∫—É–¥–∞ —Å–∫—Ä–æ–ª–ª–∏–ª–∏ –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π
    /* =====  –§–ò–õ–¨–¢–†–´ –î–õ–Ø –ö–ê–ñ–î–û–ô –ö–ê–¢–ï–ì–û–†–ò–ò  ===== */
    const categoryFilters = {
      rolls: [
        { id: 'all', name: '–í—Å–µ', fn: () => true },
        { id: 'phil', name: '–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', fn: p => p.name.toLowerCase().includes('—Ñ–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è') },
        { id: 'tempura', name: '–¢–µ–º–ø—É—Ä–∞', fn: p => p.name.toLowerCase().includes('—Ç–µ–º–ø—É—Ä–∞') },
        { id: 'hot', name: '–û—Å—Ç—Ä—ã–µ', fn: p => p.tag === 'HOT' }
      ],
      wok: [
        { id: 'all', name: '–í—Å–µ', fn: () => true },
        { id: 'chicken', name: '–° –∫—É—Ä–∏—Ü–µ–π', fn: p => p.name.toLowerCase().includes('–∫—É—Ä–∏—Ü') },
        { id: 'beef', name: '–° –≥–æ–≤—è–¥–∏–Ω–æ–π', fn: p => p.name.toLowerCase().includes('–≥–æ–≤—è–¥') },
        { id: 'spicy', name: '–û—Å—Ç—Ä—ã–π', fn: p => p.tag === 'HOT' }
      ],
      snacks: [
        { id: 'all', name: '–í—Å–µ', fn: () => true },
        { id: 'gyoza', name: '–ì—ë–¥–∑–∞', fn: p => p.name.toLowerCase().includes('–≥—ë–¥–∑–∞') },
        { id: 'edamame', name: '–≠–¥–∞–º–∞–º–µ', fn: p => p.name.toLowerCase().includes('—ç–¥–∞–º–∞–º–µ') }
      ],
      drinks: [
        { id: 'all', name: '–í—Å–µ', fn: () => true },
        { id: 'hot', name: '–ì–æ—Ä—è—á–∏–µ', fn: p => p.desc.toLowerCase().includes('–≥–æ—Ä—è—á') || p.name.toLowerCase().includes('–≥–æ—Ä—è—á') },
        { id: 'cold', name: '–•–æ–ª–æ–¥–Ω—ã–µ', fn: p => !categoryFilters.drinks.find(f => f.id === 'hot').fn(p) },
        { id: 'fresh', name: '–°–≤–µ–∂–∏–µ', fn: p => p.tag === 'NEW' }
      ]
    };
    /* —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
    let activeFilter = {
      rolls: 'all',
      wok: 'all',
      snacks: 'all',
      drinks: 'all'
    };
    function showDetails(id) {
      scrollBeforeDetail = window.pageYOffset; // –∑–∞–ø–æ–º–Ω–∏–ª–∏
      const item = menu[currentTab].find(p => p.id === id) || Object.values(menu).flat().find(p => p.id === id);
      curProd = item;
      document.getElementById('d-img').src = item.img;
      document.getElementById('d-title').innerText = item.name;
      document.getElementById('d-meta').innerText = item.meta;
      document.getElementById('d-desc').innerText = item.desc;
      openSheet('details-sheet');
      triggerHaptic('medium');
    }
    function triggerHaptic(type = 'light') {
      // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–≤–æ—Ä—è—Ç "–≤—ã–∫–ª—é—á–µ–Ω–æ" ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if (typeof settings !== 'undefined' && !settings.hapticEnabled) return;

      try {
        if (window.tg && tg.HapticFeedback) {
          if (type === 'light') tg.HapticFeedback.impactOccurred('light');
          if (type === 'medium') tg.HapticFeedback.impactOccurred('medium');
          if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
        }
      } catch (e) {
        console.error("Haptic error:", e);
      }
    }
    function switchTab(tab) {
      showAllMode = false;        // ‚Üê –≤—ã–∫–ª—é—á–∏–ª–∏ —Ä–µ–∂–∏–º ¬´–≤—Å–µ —Ç–æ–≤–∞—Ä—ã¬ª
      currentTab = tab;

      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–∞–±–æ–≤
      document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
      if (event && event.currentTarget) event.currentTarget.classList.add('active');

      triggerHaptic('light');

      // —Ä–∏—Å—É–µ–º —É–∂–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é + —Ñ–∏–ª—å—Ç—Ä—ã
      renderFilteredProducts();
      renderFilters();
    }


    function showDetails(id) {
      const item = menu[currentTab].find(p => p.id === id) || Object.values(menu).flat().find(p => p.id === id);
      curProd = item;
      document.getElementById('d-img').src = item.img;
      document.getElementById('d-title').innerText = item.name;
      document.getElementById('d-meta').innerText = item.meta;
      document.getElementById('d-desc').innerText = item.desc;
      openSheet('details-sheet');
      triggerHaptic('medium');
    }

    function addToCartFromDetails() {
      const exist = cart.find(x => x.id === curProd.id && !x.isExtra);
      if (exist) exist.qty = (exist.qty || 1) + 1;
      else cart.push({ ...curProd, qty: 1 });
      updateCartUI();
      showMiniCart();
      closeAll();
      tg.HapticFeedback.notificationOccurred('success');
    }

    function changeQty(id, delta, sizeId = 0) {
  const item = cart.find(x => x.id == id && (x.sizeId || 0) == sizeId);
  if (!item) return;
  item.qty = Math.max(1, (item.qty || 1) + delta);
  triggerHaptic('light');
  updateCartUI();
}

function removeItem(id, sizeId = 0) {
  const btn = event.target;
  const itemElement = btn.closest('.cart-item');

  if (itemElement && !itemElement.classList.contains('cart-item-dissolve')) {
    itemElement.style.maxHeight = itemElement.offsetHeight + 'px';
    itemElement.offsetHeight;
    itemElement.classList.add('cart-item-dissolve');

    triggerHaptic('medium');

    setTimeout(() => {
      cart = cart.filter(x => !(x.id == id && (x.sizeId || 0) == sizeId));
      updateCartUI();
      if (cart.length === 0) hideMiniCart();
      triggerHaptic('success');
    }, 450);
  }
}

    function removeItem(id) {
      const btn = event.target;
      const itemElement = btn.closest('.cart-item');

      if (itemElement && !itemElement.classList.contains('cart-item-dissolve')) {
        // 1. –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
        itemElement.style.maxHeight = itemElement.offsetHeight + 'px';
        itemElement.offsetHeight; // force reflow

        // 2. –ó–∞–ø—É—Å–∫–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞—Å—Ç–≤–æ—Ä–µ–Ω–∏—è
        itemElement.classList.add('cart-item-dissolve');

        // –ü–†–ê–í–ò–õ–¨–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é-—Ñ–∏–ª—å—Ç—Ä
        triggerHaptic('medium');

        setTimeout(() => {
          // –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏–∑ –º–∞—Å—Å–∏–≤–∞ (–ø–æ–¥—Ö–æ–¥–∏—Ç –∏ –¥–ª—è ID-—á–∏—Å–µ–ª, –∏ –¥–ª—è ID-—Å—Ç—Ä–æ–∫)
          cart = cart.filter(x => x.id != id);

          updateCartUI();

          if (cart.length === 0) {
            hideMiniCart();
          }

          // –ü–†–ê–í–ò–õ–¨–ù–û: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä
          triggerHaptic('success');
        }, 450);
      }
    }
    /* —Ä–∏—Å—É–µ–º —á–∏–ø—Å—ã –ø–æ–¥ —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é */
    function renderFilters() {
      const bar = document.getElementById('filter-bar');
      const cat = currentTab;        // rolls | wok | snacks | drinks
      const list = categoryFilters[cat] || [];
      const active = activeFilter[cat] || 'all';

      bar.innerHTML = list.map(f => `
    <div class="filter-chip ${f.id === active ? 'active' : ''}"
         onclick="applyFilter('${f.id}')">${f.name}</div>`).join('');
    }

    /* –∫–ª–∏–∫ –ø–æ —á–∏–ø—Å—É */
    function applyFilter(id) {
      activeFilter[currentTab] = id;
      renderFilters();          // –ø–æ–¥—Å–≤–µ—Ç–∫–∞
      renderFilteredProducts(); // —Ä–µ–∂–µ–º —Ç–æ–≤–∞—Ä—ã
      triggerHaptic('light');
    }

    /* –Ω–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞ */
    function renderFilteredProducts() {
      const bar = document.getElementById('filter-bar');

      if (showAllMode) {
        // 1. –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë
        bar.style.display = 'none';                 // –ø—Ä—è—á–µ–º –ø–æ–ª–æ—Å—É —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const allProducts = Object.values(menu).flat();
        renderFiltered(allProducts);
      } else {
        // 2. –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        bar.style.display = 'flex';                 // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        const base = menu[currentTab] || [];
        const fid = activeFilter[currentTab] || 'all';
        const filterObj = categoryFilters[currentTab].find(f => f.id === fid);
        const filtered = base.filter(filterObj.fn);
        renderFiltered(filtered);
      }
    }
    /* =============  –ë–´–°–¢–†–´–ô –ë–ò–õ–î-–ö–ê–†–¢–û–ß–ö–ò  ============= */
function buildCard(p, i = 0) {
  const sizeId = lastSize[p.id] || 0;           // –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä
  const inCart = getCartItem(p.id, sizeId);
  const qty    = inCart ? inCart.qty : 0;
  const price  = p.sizes ? p.sizes[sizeId].price : p.price;

  let sizeHtml = '';
  if (p.sizes?.length > 1) {
    sizeHtml = `<div class="size-row">
      ${p.sizes.map((s, idx) =>
        `<span class="size-chip ${sizeId === idx ? 'active' : ''}"
               onclick="toggleSize(event,${p.id},${idx})">${s.vol}</span>`).join('')}
    </div>`;
  }

  return `
  <div class="item" style="animation-delay:${i * 0.1}s">
    ${p.tag ? `<div class="badge"><span class="badge-icon">${p.tagIcon}</span><span>${p.tag}</span></div>` : ''}
    <img src="${p.img}" class="item-img" onclick="showDetails(${p.id})">
    <div style="font-weight:800;font-size:15px" onclick="showDetails(${p.id})">${p.name}</div>
    <div style="font-size:11px;color:var(--text-gray)" onclick="showDetails(${p.id})">${p.meta}</div>

    <div class="counter-row">
      <button class="counter-btn" onclick="changeQtyCard(event,${p.id},-1)">‚àí</button>
      <span class="counter-val">${qty}</span>
      <button class="counter-btn" onclick="changeQtyCard(event,${p.id},1)">+</button>
    </div>

    ${sizeHtml}

    <div class="price-row" onclick="showDetails(${p.id})">
      <span class="p-val">${price}‚ÇΩ</span>
    </div>
  </div>`;
}

    function addExtra(id) {
      const item = extras.find(e => e.id === id);
      if (!item) return;

      // –í–∞–∂–Ω–æ: –∏—â–µ–º –∏–º–µ–Ω–Ω–æ —Å —Ñ–ª–∞–≥–æ–º isExtra, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø—É—Ç–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –º–µ–Ω—é
      const exist = cart.find(x => x.id === id && x.isExtra);

      if (exist) {
        exist.qty = (exist.qty || 1) + 1;
      } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞—è –≤—Å–µ –ø–æ–ª—è
        cart.push({
          ...item,
          qty: 1,
          isExtra: true
        });
      }
      // –£–±—Ä–∞–ª–∏ –æ—Ç—Å—é–¥–∞ updateCartUI(), —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –∑–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
    }

    function applyPromo() {
      const code = document.getElementById('promo-input').value.trim().toUpperCase();
      if (code === 'YAKUZA') {
        promoApplied = true;
        tg.showAlert('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω! –î–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è.');
      } else {
        tg.showAlert('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }
      updateCartUI();
    }

    // —Å—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å –∏ –ø–ª–∞–≤–Ω–æ —Å–∫—Ä–æ–ª–ª–∏–º –∫ –ø–æ–ª—é, —á—Ç–æ–±—ã –∫—É—Ä—Å–æ—Ä –±—ã–ª –≤–∏–¥–µ–Ω
    function focusField(el) {
      el.focus();
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // –ø–æ–¥–Ω–∏–º–∞–µ–º –µ—â—ë –≤—ã—à–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∞ –ø–æ–ª–µ
      setTimeout(() => window.scrollBy(0, 120), 300);
    }

  

    function updateCartUI() {
  /* 0. –û–ë–ù–û–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û –°–ß–Å–¢–ß–ò–ö–ò –ù–ê –ö–ê–†–¢–û–ß–ö–ê–• ‚Äì –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ */
  cart.forEach(item => {
    const card = document.querySelector(`.item img[onclick*="showDetails(${item.id})"]`)?.closest('.item');
    if (!card) return;

    // —Å—á—ë—Ç—á–∏–∫
    const counterEl = card.querySelector('.counter-val');
    if (counterEl) counterEl.textContent = item.qty || 0;

    // —Ä–∞–∑–º–µ—Ä—ã –∏ —Ü–µ–Ω–∞
    if (item.sizes?.length) {
      const activeSizeId = item.sizeId || 0;
      const priceEl  = card.querySelector('.p-val');
      const sizeChips = card.querySelectorAll('.size-chip');

      if (priceEl) priceEl.textContent = item.sizes[activeSizeId].price + '‚ÇΩ';

      sizeChips.forEach((chip, idx) => {
        chip.classList.toggle('active', idx === activeSizeId);
      });
    }
  });

  /* 1. –ú–ò–ù–ò-–ö–û–†–ó–ò–ù–ê */
  const subMini = cart.reduce((s, i) => s + i.price * (i.qty || 1), 0);
  const miniSumEl = document.getElementById('mini-sum');
  if (miniSumEl) miniSumEl.innerText = subMini + '‚ÇΩ';

  /* 2. –°–ï–¢–ö–ê –î–û–ü–û–í ‚Äì –±–µ–∑ –∏–∫–æ–Ω–æ–∫, —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è */
  const extrasGrid = document.getElementById('extras-grid');
  if (extrasGrid) {
    extrasGrid.innerHTML = extras.map(e =>
      `<div class="extra-card" onclick="addExtraWithAnim('${e.id}', event)">${e.name}</div>`).join('');
  }

  /* 3. –ò–¢–û–ì–û–í–ê–Ø –°–£–ú–ú–ê –ò –î–û–°–¢–ê–í–ö–ê */
  let subtotal = cart.reduce((s, i) => s + i.price * (i.qty || 1), 0);
  const freeDeliveryThreshold = 900;
  let delivery = 0;
  if (!promoApplied && subtotal < freeDeliveryThreshold) delivery = 150;
  const total = subtotal + delivery;

  const totalEl = document.getElementById('total-val');
  if (totalEl) totalEl.innerText = total + '‚ÇΩ';

  const freeEl = document.getElementById('delivery-free');
  if (freeEl) {
    freeEl.innerText = delivery === 0
      ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞'
      : `–î–æ—Å—Ç–∞–≤–∫–∞ 150‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç ${freeDeliveryThreshold}‚ÇΩ)`;
  }

  /* 4. –ê–î–†–ï–° */
  const addrEl = document.getElementById('address');
  if (addrEl) addrEl.value = userData.address || '';

  /* 5. –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í –í –ö–û–†–ó–ò–ù–ï ‚Äì –±–µ–∑ –∏–∫–æ–Ω–æ–∫ —É extra */
  const list = document.getElementById('cart-items');
  const empty = document.getElementById('cart-empty');
  if (list) {
    if (cart.length === 0) {
      if (empty) empty.style.display = 'block';
      list.innerHTML = '';
    } else {
      if (empty) empty.style.display = 'none';
      list.innerHTML = cart.map(i => {
  const sizeLabel = i.sizes ? ` (${i.sizes[i.sizeId || 0].vol})` : '';
  return `
    <div class="cart-item">
      <div class="cart-info">
        <b>${i.name}${sizeLabel}</b>
        ${!i.isExtra ? `<br><small>${i.price}‚ÇΩ</small>` : ''}
      </div>
      <div class="cart-controls">
        <button class="cart-btn" onclick="changeQty('${i.id}', -1, ${i.sizeId || 0})">‚àí</button>
        <span class="cart-qty">${i.qty || 1}</span>
        <button class="cart-btn" onclick="changeQty('${i.id}', 1, ${i.sizeId || 0})">+</button>
      </div>
      <span class="cart-price">${i.price * (i.qty || 1)}‚ÇΩ</span>
      <span class="cart-remove" onclick="removeItem('${i.id}', ${i.sizeId || 0})">–£–¥–∞–ª–∏—Ç—å</span>
    </div>`;
}).join('');
    }
  }

  /* 6. –ü–û–ö–ê–ó–ê–¢–¨/–°–ö–†–´–¢–¨ –ú–ò–ù–ò-–ö–û–†–ó–ò–ù–£ */
  const mc = document.getElementById('mini-cart');
  if (mc) {
    if (cart.length) {
      mc.style.display = 'flex';
    } else {
      mc.style.display = 'none';
    }
  }
}




    function addExtraWithAnim(id, event) {
      const item = extras.find(e => e.id === id);
      const card = event.currentTarget;
      const miniCart = document.getElementById('mini-cart');

      // –°–æ–∑–¥–∞–µ–º –ª–µ—Ç—è—â–∏–π —ç–ª–µ–º–µ–Ω—Ç (—Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏)
      const particle = document.createElement('div');
      particle.className = 'flying-particle';
      particle.innerText = item.icon;

      const rect = card.getBoundingClientRect();
      particle.style.left = rect.left + 'px';
      particle.style.top = rect.top + 'px';
      document.body.appendChild(particle);

      // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
      triggerHaptic('light');

      addExtra(id);

      const cartRect = miniCart.getBoundingClientRect();
      requestAnimationFrame(() => {
        particle.style.left = (cartRect.left + 20) + 'px';
        particle.style.top = (cartRect.top + 10) + 'px';
        particle.style.transform = 'scale(0.3) rotate(360deg)';
        particle.style.opacity = '0';
      });

      setTimeout(() => {
        particle.remove();
        updateCartUI();

        miniCart.style.transform = 'scale(1.2)';
        setTimeout(() => miniCart.style.transform = 'scale(1)', 200);

        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ "–ø–æ–ø–∞–¥–∞–Ω–∏–∏" –≤ –∫–æ—Ä–∑–∏–Ω—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
        triggerHaptic('success');
      }, 700);
    }
    function setPay(m, el) { payMethod = m; document.querySelectorAll('.pay-opt').forEach(o => o.classList.remove('active')); el.classList.add('active'); }

    function closeAll() {
      document.querySelectorAll('.sheet').forEach(s => s.classList.remove('active'));
      document.getElementById('overlay').classList.remove('active');
      document.body.classList.remove('no-scroll');

      // –∂–¥—ë–º 400 –º—Å (–≤—Ä–µ–º—è transition) –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Å–∫—Ä–æ–ª–ª–∏–º
      setTimeout(() => {
        window.scrollTo({ top: scrollBeforeDetail, behavior: 'smooth' });
      }, 400);
    }

    function openSheet(id) {
      document.getElementById(id).classList.add('active');
      document.getElementById('overlay').classList.add('active');
      document.body.classList.add('no-scroll');
    }

    function openCart() { openSheet('cart-sheet'); }
    function openProfile() {
      const user = tg.initDataUnsafe?.user;
      if (user) {
        userData.name = user.first_name || '';
        userData.phone = user.username ? '@' + user.username : (user.id || '');
        if (user.photo_url) {
          document.getElementById('user-avatar').src = user.photo_url;
          document.getElementById('profile-avatar').src = user.photo_url;
        }
      }
      document.getElementById('profile-name').innerText = userData.name;
      document.getElementById('profile-phone').innerText = userData.phone;
      document.getElementById('profile-bonus').innerText = userData.bonus.toLocaleString() + ' ‚ÇΩ';
      document.getElementById('profile-address').value = userData.address;
      openSheet('profile-sheet');
    }

    function saveProfile() {
      userData.address = document.getElementById('profile-address').value;
      tg.showAlert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
      closeAll();
    }

    /* ----------  –ø–æ–∏—Å–∫-–æ—Å—Ç—Ä–æ–≤–æ–∫: –∫—Ä—É–≥–ª—ã–π ‚Üí –∑–∞–∫—Ä—É–≥–ª—ë–Ω–Ω–∞—è –ø–ª–∞—à–∫–∞  ---------- */
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');

    searchBtn.addEventListener('click', () => {
      const isOpen = searchForm.classList.contains('open');
      if (!isOpen) {                // –æ—Ç–∫—Ä—ã–≤–∞–µ–º
        searchForm.classList.add('open');
        searchInput.focus();
      } else {                      // –∑–∞–∫—Ä—ã–≤–∞–µ–º
        searchForm.classList.remove('open');
        searchInput.value = '';
        filterProducts('');
      }
    });

    searchInput.addEventListener('input', e => filterProducts(e.target.value.toLowerCase()));
    function filterProducts(q) {
      const all = Object.values(menu).flat();
      const filtered = all.filter(p =>
        p.name.toLowerCase().includes(q) ||
        p.desc.toLowerCase().includes(q) ||
        (q.includes('–æ—Å—Ç—Ä–æ–µ') && p.tag === 'HOT') ||
        (q.includes('–≤–µ–≥–∞–Ω') && p.desc.includes('–æ–≤–æ—â–∏'))
      );
      renderFiltered(filtered.length ? filtered : all);
    }
    function getQtyInCart(id, sizeId = 0) {
  const item = cart.find(x => x.id == id && (x.sizeId || 0) == sizeId && !x.isExtra);
  return item ? item.qty : 0;
}
    function renderFiltered(list) {
  document.getElementById('grid').innerHTML = list.map((p, i) => buildCard(p, i)).join('');
}

    function showAllCategories() {
      showAllMode = true;                       // ‚Üê –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º ¬´–≤—Å–µ —Ç–æ–≤–∞—Ä—ã¬ª
      document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
      renderFilteredProducts();                 // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
      triggerHaptic('medium');
    }

    /* helpers */
function getCartItem(pid, sizeId = 0) {
  return cart.find(x => x.id == pid && ((x.sizeId || 0) == sizeId));
}

/* –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç—Ä–æ–∫—É —Ä–∞–∑–º–µ—Ä–æ–≤ */
function toggleSizeRow(e, pid) {
  e.stopPropagation();
  const row = document.getElementById('size-' + pid);
  row.style.display = row.style.display == 'none' ? 'flex' : 'none';
}

/* –≤—ã–±—Ä–∞—Ç—å —Ä–∞–∑–º–µ—Ä */
function toggleSize(e, pid, sizeId) {
  e.stopPropagation();
  const p = Object.values(menu).flat().find(x => x.id == pid);
  lastSize[pid] = sizeId;                       // –∑–∞–ø–æ–º–Ω–∏–ª–∏

  /* –µ—Å–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ —É–∂–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä ‚Äì —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ–º –æ–±—ä—ë–º –∏ —Ü–µ–Ω—É */
  let item = getCartItem(pid);                  // –∏—â–µ–º –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ size
  if (item) {
    item.sizeId = sizeId;
    item.price  = p.sizes[sizeId].price;
    updateCartUI();
    triggerHaptic('light');
    return;
  }

  /* –µ—Å–ª–∏ –Ω–µ—Ç ‚Äì –¥–æ–±–∞–≤–ª—è–µ–º 1 —à—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä—ë–º–∞ */
  cart.push({ ...p, qty: 1, sizeId, price: p.sizes[sizeId].price });
  updateCartUI();
  showMiniCart();
  triggerHaptic('success');
}

/* +/- –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ */
function changeQtyCard(e, pid, delta) {
  e.stopPropagation();
  const p      = Object.values(menu).flat().find(x => x.id == pid);
  const sizeId = lastSize[pid] || 0;            // –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä
  let item     = getCartItem(pid, sizeId);

  if (!item) {                                  // –ø–µ—Ä–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
    if (delta < 0) return;                      // —É–±–∞–≤–ª—è—Ç—å –Ω–µ—á–µ–≥–æ
    item = { ...p, qty: 0, sizeId, price: p.sizes ? p.sizes[sizeId].price : p.price };
    cart.push(item);
  }

  item.qty = Math.max(0, item.qty + delta);
  if (item.qty === 0) cart = cart.filter(x => !(x.id == pid && (x.sizeId || 0) == sizeId));

  updateCartUI();
  if (item.qty === 1 && delta > 0) showMiniCart();
  triggerHaptic(item.qty ? 'light' : 'medium');
}


    /* ---------- –§–ò–ù–ê–õ–¨–ù–´–ô –†–ê–ë–û–ß–ò–ô –ö–û–î ---------- */
    (function () {
      function initApp() {
        const myTheme = document.getElementById('theme-toggle');
        const myHaptic = document.getElementById('haptic-toggle');

        if (myTheme) {
          // ‚òÖ —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±–∏—Ä–∞–ª
          if (!localStorage.getItem('yakuza-theme')) {
            localStorage.setItem('yakuza-theme', 'dark');
            document.body.dataset.theme = 'dark';
          }

          myTheme.checked = document.body.dataset.theme === 'dark';
          myTheme.onchange = function () {
            const isDark = myTheme.checked;
            document.body.dataset.theme = isDark ? 'dark' : 'light';
            localStorage.setItem('yakuza-theme', isDark ? 'dark' : 'light');
            if (typeof settings !== 'undefined' && settings.hapticEnabled && window.tg) {
              tg.HapticFeedback.impactOccurred('light');
            }
          };
        }

        if (myHaptic) {
          const isHap = localStorage.getItem('haptic-enabled') !== 'false';
          if (typeof settings !== 'undefined') settings.hapticEnabled = isHap;
          myHaptic.checked = isHap;
          myHaptic.onchange = function () {
            const val = myHaptic.checked;
            if (typeof settings !== 'undefined') settings.hapticEnabled = val;
            localStorage.setItem('haptic-enabled', val);
            if (val && window.tg) tg.HapticFeedback.notificationOccurred('success');
          };
        }
        tryAutoAddress();
      }

      // –∑–∞–ø—É—Å–∫
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
      } else {
        initApp();
      }
    })();
    /* ----------  –ü–õ–ê–í–ê–Æ–©–ê–Ø –ö–û–†–ó–ò–ù–ê  ---------- */
    function showMiniCart() {
      const mc = document.getElementById('mini-cart');
      mc.style.display = 'flex';
      mc.animate([{ transform: 'scale(0.8)', opacity: 0 }, { transform: 'scale(1)', opacity: 1 }], { duration: 200, fill: 'forwards' });
    }
    function hideMiniCart() {
      document.getElementById('mini-cart').style.display = 'none';
    }

    /* ----------  –°–í–ê–ô–ü-–ó–ê–ö–†–´–¢–ò–ï  ---------- */
    document.querySelectorAll('.sheet').forEach(sh => {
      const h = new Hammer(sh);
      h.on('swipedown', closeAll);
    });
    function tryAutoAddress() {
      if (!navigator.geolocation) return;
      if (localStorage.getItem('auto-address-used')) return;

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const { latitude, longitude } = pos.coords;
          try {
            const res = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`
            );
            const data = await res.json();
            const addr = data.display_name || '';
            if (addr) {
              userData.address = addr;
              document.getElementById('address').value = addr;
              document.getElementById('profile-address').value = addr;
              localStorage.setItem('auto-address-used', '1');
            }
          } catch (e) {
            console.warn('Geo error', e);
          }
        },
        (err) => console.warn('Geo fail', err),
        { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
      );
    }
    function sendOrder() {
      if (cart.length === 0) {
        tg.showAlert("–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
        return;
      }

      const address = document.getElementById('address').value;
      if (!address) {
        tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.");
        return;
      }

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–æ—Ç–∞
      const data = {
        items: cart,
        total: document.getElementById('total-val').innerText.replace('‚ÇΩ', ''),
        address: address,
        payMethod: payMethod,
        phone: userData.phone
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–∑–∞–∫—Ä–æ–µ—Ç Mini App –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
      tg.sendData(json.stringify(data));
    }


    initHeroSlider();
    renderFilteredProducts();
    updateCartUI();
  </script>
</body>

</html>