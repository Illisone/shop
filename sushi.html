<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style_sushi.css">
</head>
<body>

<div class="header">
    <div style="font-weight:900; font-size:22px; letter-spacing:-1px;">YAKUZA</div>
    <div style="display:flex; gap:12px; align-items:center;">
        <div onclick="openCart()" style="position:relative; background:#1a1a1c; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
            <span style="font-size:20px;">üõí</span>
            <div id="c-count" style="position:absolute; top:-2px; right:-2px; background:var(--accent); color:white; font-size:10px; width:18px; height:18px; border-radius:50%; display:none; align-items:center; justify-content:center; font-weight:bold; border:2px solid #000;">0</div>
        </div>
        <img id="u-avatar" class="user-avatar" src="https://via.placeholder.com/100">
    </div>
</div>

<div class="main-content">
    <div class="stories-container">
        <div class="story-card" style="background: linear-gradient(to top, #FF2D55, transparent);">
            <img src="https://images.unsplash.com/photo-1553621042-f6e147245754?w=300">
            <span>–°–∫–∏–¥–∫–∞ -20% –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</span>
        </div>
        <div class="story-card" style="background: linear-gradient(to top, #d4ff33, transparent);">
            <img src="https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=300">
            <span style="color:black">–°—á–∞—Å—Ç–ª–∏–≤—ã–µ —á–∞—Å—ã 14:00-17:00</span>
        </div>
        <div class="story-card">
            <img src="https://images.unsplash.com/photo-1611143669185-af224c5e3252?w=300">
            <span>–ü–æ–¥–∞—Ä–æ–∫ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 3000‚ÇΩ</span>
        </div>
    </div>

    <h3 style="margin:10px 20px 15px; font-weight:800; font-size:22px;">–ù–∞—à–µ –º–µ–Ω—é</h3>
    <div class="grid" id="grid"></div>
</div>

<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div id="cart-sheet" class="sheet">
    <div style="width:40px; height:4px; background:#333; border-radius:10px; margin: 0 auto 20px;"></div>
    <h2 style="margin:0 0 20px; font-size:28px; font-weight:900;">–í–∞—à –∑–∞–∫–∞–∑</h2>
    
    <div id="cart-items"></div>

    <div id="cart-empty-msg" style="text-align:center; padding:40px 0; color:var(--gray); display:none;">
        –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
    </div>

    <div id="cart-controls" style="margin-top:20px;">
        <button class="geo-btn" onclick="getLocation()">
            üìç <span>–£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
        </button>
        <input type="text" id="address" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞" style="width:100%; background:#1c1c1e; border:1px solid #333; padding:18px; border-radius:18px; color:white; font-size:16px; box-sizing:border-box; margin-bottom:20px; outline:none;">

        <div style="font-size:14px; font-weight:700; color:var(--gray); margin-bottom:10px;">–°–ü–û–°–û–ë –û–ü–õ–ê–¢–´</div>
        <div class="payment-selector">
            <div class="pay-option active" onclick="setPay('cash', this)">–ù–∞–ª–∏—á–Ω—ã–µ</div>
            <div class="pay-option" onclick="setPay('card', this)">–¢–µ—Ä–º–∏–Ω–∞–ª</div>
            <div class="pay-option" onclick="setPay('online', this)">–û–Ω–ª–∞–π–Ω</div>
        </div>

        <button class="btn-order" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Ä¢ <span id="total-val">0</span>‚ÇΩ</button>
    </div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —é–∑–µ—Ä–∞
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        if (user.photo_url) {
            document.getElementById('u-avatar').src = user.photo_url;
        }
    }

    let cart = [];
    let paymentMethod = 'cash';

    const products = [
        {id: 1, name: "–ú–µ—á—Ç–∞ –∫–æ—Ç–∞", priceDel: 1530, meta: "1050 –≥", img: "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=600"},
        {id: 2, name: "–°–µ—Ç –ó–∏–º–Ω–∏–π", priceDel: 1945, meta: "2100 –≥", img: "https://images.unsplash.com/photo-1583623025817-d180a2221d0a?w=600"},
        {id: 3, name: "–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è", priceDel: 650, meta: "280 –≥", img: "https://images.unsplash.com/photo-1553621042-f6e147245754?w=600"}
    ];

    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = products.map(p => `
            <div class="item" onclick="addToCart(${p.id})">
                <img src="${p.img}" class="item-img">
                <div style="font-weight:800; font-size:16px;">${p.name}</div>
                <div style="font-size:12px; color:var(--gray); margin-bottom:10px;">${p.meta}</div>
                <div style="font-weight:900; color:var(--accent-pickup); font-size:18px;">${p.priceDel} ‚ÇΩ</div>
                <div style="position:absolute; bottom:12px; right:12px; background:var(--accent); width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:bold;">+</div>
            </div>
        `).join('');
    }

    function addToCart(id) {
        const p = products.find(x => x.id === id);
        cart.push(p);
        updateCart();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function updateCart() {
        const count = document.getElementById('c-count');
        count.innerText = cart.length;
        count.style.display = cart.length > 0 ? 'flex' : 'none';
        document.getElementById('total-val').innerText = cart.reduce((s, i) => s + i.priceDel, 0);
    }

    function openCart() {
        const list = document.getElementById('cart-items');
        if (cart.length === 0) {
            list.innerHTML = '';
            document.getElementById('cart-empty-msg').style.display = 'block';
            document.getElementById('cart-controls').style.display = 'none';
        } else {
            document.getElementById('cart-empty-msg').style.display = 'none';
            document.getElementById('cart-controls').style.display = 'block';
            list.innerHTML = cart.map((i, idx) => `
                <div class="cart-item">
                    <div><b>${i.name}</b><br><small style="color:var(--gray)">${i.priceDel} ‚ÇΩ</small></div>
                    <div style="color:var(--accent); font-weight:700;" onclick="removeFromCart(${idx})">–£–¥–∞–ª–∏—Ç—å</div>
                </div>
            `).join('');
        }
        document.getElementById('cart-sheet').classList.add('active');
        document.getElementById('overlay').classList.add('active');
    }

    function removeFromCart(idx) {
        cart.splice(idx, 1);
        updateCart();
        openCart();
    }

    function setPay(method, el) {
        paymentMethod = method;
        document.querySelectorAll('.pay-option').forEach(opt => opt.classList.remove('active'));
        el.classList.add('active');
        tg.HapticFeedback.impactOccurred('light');
    }

    function getLocation() {
        tg.LocationManager.getLocation((data) => {
            if (data) {
                document.getElementById('address').value = `–®–∏—Ä–æ—Ç–∞: ${data.latitude.toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${data.longitude.toFixed(4)}`;
            } else {
                tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏");
            }
        });
    }

    function closeAll() {
        document.querySelectorAll('.sheet').forEach(s => s.classList.remove('active'));
        document.getElementById('overlay').classList.remove('active');
    }

    function sendOrder() {
        if (cart.length === 0) return;
        const addr = document.getElementById('address').value;
        if (!addr) { tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"); return; }
        
        const orderData = {
            items: cart,
            address: addr,
            payment: paymentMethod,
            total: document.getElementById('total-val').innerText
        };
        tg.sendData(JSON.stringify(orderData));
    }

    render();
</script>
</body>
</html>