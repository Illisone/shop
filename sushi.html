<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>YAKUZA –°—É—à–∏</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

  <style>
  :root{
    --bg:#f4f4f6;
    --card:#ffffff;
    --text:#000000;
    --text-gray:#6c6c70;
    --accent:#ff2d55;
    --accent-light:#32d74b;
    --glass:rgba(255,255,255,0.7);
    --border:rgba(0,0,0,0.08);
    --shadow:0 8px 32px rgba(0,0,0,0.08);
    --radius:24px;
  }
  body[data-theme="dark"]{
    --bg:#000000;
    --card:#111113;
    --text:#ffffff;
    --text-gray:#8e8e93;
    --accent:#ff2d55;
    --accent-light:#b1ff5c;
    --glass:rgba(255,255,255,0.05);
    --border:rgba(255,255,255,0.08);
    --shadow:0 8px 32px rgba(255,45,85,0.25);
  }
  *{box-sizing:border-box;-webkit-font-smoothing:antialiased;}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;scroll-behavior:smooth;}
  html,body{height:100%;}
  .top-line{display:flex;align-items:center;justify-content:space-between;padding:10px 20px 0;}
  .logo-island{background:var(--glass);backdrop-filter:blur(20px);border:0.5px solid var(--border);border-radius:var(--radius);padding:8px 14px;font-weight:900;font-size:18px;letter-spacing:-0.5px;}
  .bals-user{display:flex;align-items:center;gap:12px;}
  .bals{display:flex;align-items:center;gap:6px;background:var(--card);border-radius:12px;padding:6px 10px;font-size:13px;font-weight:600;border:0.5px solid var(--border);}
  .bals-icon{color:var(--accent-light);}
  .user-avatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;cursor:pointer;}
  .search-line{display:flex;align-items:center;gap:8px;margin:0 20px 12px;}
  #search-icon{font-size:20px;color:var(--text-gray);cursor:pointer;transition:color .2s;}
  #search-wrap{flex:1;max-width:0;overflow:hidden;transition:max-width .3s ease;}
  #search-wrap.open{max-width:100%;}
  #search-input{width:100%;background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:8px 12px;color:var(--text);font-size:14px;}
  .hero-slider{position:relative;width:calc(100% - 40px);height:180px;margin:12px auto;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
  .hero-slide{position:absolute;inset:0;opacity:0;transition:opacity 1s ease;}
  .hero-slide img{width:100%;height:100%;object-fit:cover;}
  .hero-slide.active{opacity:1;}
  .hero-text{position:absolute;bottom:16px;left:20px;right:20px;font-size:18px;font-weight:800;text-shadow:0 1px 4px rgba(0,0,0,.7);}
  .main-content{padding-top:12px;padding-bottom:calc(70px + env(safe-area-inset-bottom,0));}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;padding:0 20px;}
  .item{background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid var(--border);box-shadow:var(--shadow);animation:slideUp .5s ease backwards;transition:transform .25s,background .25s;}
  .item:active{transform:scale(0.96);background:#1a1a1c;}
  .item-img{width:100%;aspect-ratio:1.15 / 1;border-radius:18px;object-fit:cover;margin-bottom:10px;transform:scale(1.05);transform-origin:center;}
  .badge{position:absolute;top:12px;right:12px;display:flex;align-items:center;gap:4px;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);padding:4px 8px;border-radius:8px;font-size:11px;font-weight:800;z-index:2;}
  .price-row{margin-top:8px;border-top:1px solid rgba(255,255,255,.06);padding-top:8px;text-align:right;}
  .p-val{font-size:15px;font-weight:800;}
  .bottom-tabs{position:fixed;bottom:0;left:0;right:0;height:calc(60px + env(safe-area-inset-bottom,0));background:var(--glass);backdrop-filter:blur(20px);border-top:0.5px solid var(--border);display:flex;z-index:1001;padding-bottom:env(safe-area-inset-bottom,0);}
  .bottom-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;background:none;border:none;color:var(--text-gray);font-size:11px;font-weight:600;transition:color .2s;}
  .bottom-tab.active{color:var(--accent-light);}
  .bottom-icon{font-size:22px;line-height:1;}
  #mini-cart{position:fixed;bottom:80px;right:20px;width:150px;height:50px;background:var(--accent);color:#fff;border-radius:25px;display:none;align-items:center;justify-content:center;gap:8px;font-weight:800;font-size:14px;box-shadow:var(--shadow);z-index:999;cursor:pointer;transition:transform .2s;}
  #mini-cart:active{transform:scale(0.95);}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(8px);opacity:0;visibility:hidden;z-index:1500;transition:.3s;}
  .overlay.active{opacity:1;visibility:visible;}
  .sheet{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-radius:32px 32px 0 0;padding:24px 20px 40px;max-height:85vh;overflow:hidden;z-index:2000;transform:translateY(105%);transition:transform .5s cubic-bezier(.19,1,.22,1);box-shadow:var(--shadow);display:flex;flex-direction:column;}
  .sheet.active{transform:translateY(0);}
  .sheet-handle{width:40px;height:4px;background:#333;border-radius:10px;margin:0 auto 15px;}
  .sheet-scroll{flex:1;overflow-y:auto;margin:0 -20px;padding:0 20px;}
  .btn-main{width:100%;background:var(--accent-light);color:#000;border:none;padding:20px;border-radius:22px;font-weight:800;font-size:16px;margin-top:10px;transition:transform .15s,background .15s;}
  .btn-main:active{transform:scale(0.97);background:#c4ff4c;}
  .input-style{width:100%;background:var(--card);border:1px solid var(--border);padding:18px;border-radius:18px;color:var(--text);margin-bottom:15px;outline:none;transition:border-color .2s;}
  .input-style:focus{border-color:var(--accent);}
  .pay-selector{display:flex;background:var(--glass);border-radius:16px;padding:4px;margin:20px 0;}
  .pay-opt{flex:1;text-align:center;padding:12px;font-size:12px;font-weight:700;border-radius:12px;color:var(--text-gray);transition:background .2s,color .2s;}
  .pay-opt.active{background:#333;color:var(--accent-light);}
  .cart-item{display:flex;align-items:center;gap:12px;background:var(--glass);border-radius:20px;padding:14px;margin-bottom:10px;border:1px solid var(--border);}
  .cart-info{flex:1;}
  .cart-controls{display:flex;align-items:center;gap:8px;}
  .cart-btn{width:28px;height:28px;border-radius:50%;background:var(--glass);color:var(--text);border:none;font-size:16px;display:grid;place-items:center;border:1px solid var(--border);}
  .cart-qty{font-weight:800;font-size:15px;width:24px;text-align:center;}
  .cart-price{font-weight:800;font-size:15px;}
  .cart-remove{margin-left:auto;color:var(--accent);font-weight:800;font-size:13px;}
  .promo-row{display:flex;gap:8px;margin:15px 0;}
  .promo-input{flex:1;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;color:var(--text);font-size:14px;}
  .promo-btn{background:var(--glass);color:var(--accent-light);border:none;border-radius:12px;padding:0 16px;font-weight:700;border:1px solid var(--border);}
  .total-row{display:flex;justify-content:space-between;align-items:center;margin-top:15px;font-size:17px;font-weight:800;}
  .delivery-free{color:var(--accent-light);font-size:13px;margin-top:4px;}
  .extras-title{font-size:16px;font-weight:800;margin:20px 0 10px;}
  .extras-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
  .extra-card{background:var(--glass);border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;transition:background .2s;}
  .extra-card:active{background:#222;}
  .extra-icon{font-size:20px;margin-bottom:4px;}
  .profile-card{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:20px;text-align:center;margin-bottom:20px;}
  .profile-avatar-large{width:80px;height:80px;border-radius:50%;border:3px solid var(--accent);margin:0 auto 10px;object-fit:cover;}
  .profile-name{font-size:20px;font-weight:800;color:var(--text);}
  .profile-phone{color:var(--text-gray);font-size:14px;margin-bottom:15px;}
  .profile-bonus-card{background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:15px;}
  .profile-bonus-label{font-size:13px;color:var(--text-gray);}
  .profile-bonus-val{font-size:24px;font-weight:800;color:var(--accent-light);}
  .theme-switch{position:relative;display:inline-flex;align-items:center;gap:8px;margin-top:8px;}
  .theme-switch input{opacity:0;width:0;height:0;}
  .slider{width:44px;height:24px;background:var(--glass);border-radius:12px;position:relative;cursor:pointer;transition:background .2s;border:1px solid var(--border);}
  .slider:before{content:'';position:absolute;width:20px;height:20px;background:var(--accent-light);border-radius:50%;top:2px;left:2px;transition:transform .2s;}
  body[data-theme="dark"] .slider{background:var(--card);}
  body[data-theme="dark"] .slider:before{transform:translateX(20px);}
  .labels{font-size:16px;color:var(--text);}
  @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
  </style>
</head>
<body>
<!-- TOP-LINE -->
<div class="top-line">
  <div class="logo-island">YAKUZA</div>
  <div class="bals-user">
    <div class="bals"><span class="bals-icon">üíé</span><span id="bals-val">1 250</span></div>
    <img id="user-avatar" class="user-avatar" src="https://via.placeholder.com/100" alt="" onclick="openProfile()">
  </div>
</div>

<!-- SEARCH -->
<div class="search-line">
  <span id="search-icon">üîç</span>
  <div id="search-wrap">
    <input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤">
  </div>
</div>

<!-- CONTENT -->
<div class="main-content">
  <div class="hero-slider" id="hero-slider"></div>
  <div class="grid" id="grid"></div>
</div>

<!-- BOTTOM TABS -->
<nav class="bottom-tabs">
  <button class="bottom-tab active" onclick="switchTab('rolls')"><span class="bottom-icon">üç£</span><span>–†–æ–ª–ª—ã</span></button>
  <button class="bottom-tab" onclick="switchTab('wok')"><span class="bottom-icon">üçú</span><span>–í–æ–∫–∏</span></button>
  <button class="bottom-tab" onclick="switchTab('snacks')"><span class="bottom-icon">ü•ü</span><span>–ó–∞–∫—É—Å–∫–∏</span></button>
  <button class="bottom-tab" onclick="switchTab('drinks')"><span class="bottom-icon">ü•§</span><span>–ù–∞–ø–∏—Ç–∫–∏</span></button>
</nav>

<!-- MINI-CART -->
<div id="mini-cart" onclick="openCart()"><span>üõí</span><span id="mini-sum">0‚ÇΩ</span></div>

<!-- OVERLAY & SHEETS -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<!-- DETAILS SHEET -->
<div id="details-sheet" class="sheet">
  <div class="sheet-handle"></div>
  <img id="d-img" style="width:100%;border-radius:22px;height:260px;object-fit:cover;">
  <h2 id="d-title" style="margin:20px 0 5px;font-size:26px;font-weight:900;"></h2>
  <p id="d-meta" style="color:var(--text-gray);font-size:14px;margin-bottom:15px;"></p>
  <p id="d-desc" style="color:#bbb;line-height:1.5;font-size:15px;margin-bottom:20px;"></p>
  <button class="btn-main" onclick="addToCartFromDetails()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
</div>

<!-- CART SHEET -->
<div id="cart-sheet" class="sheet">
  <div class="sheet-handle"></div>
  <h2 style="margin:0 0 20px;font-weight:900;">–í–∞—à –∑–∞–∫–∞–∑</h2>
  <div class="sheet-scroll">
    <div id="cart-items"></div>
    <div id="cart-empty" style="text-align:center;padding:30px;color:var(--text-gray);display:none;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
    <div class="extras-title">–î–æ–±–∞–≤–∏—Ç—å –∫ –∑–∞–∫–∞–∑—É?</div>
    <div class="extras-grid" id="extras-grid"></div>
    <div class="promo-row">
      <input type="text" class="promo-input" id="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
      <button class="promo-btn" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
    <div class="pay-selector">
      <div class="pay-opt active" onclick="setPay('cash',this)">–ù–∞–ª–∏—á–Ω—ã–µ</div>
      <div class="pay-opt" onclick="setPay('card',this)">–ö–∞—Ä—Ç–æ–π</div>
      <div class="pay-opt" onclick="setPay('online',this)">–û–Ω–ª–∞–π–Ω</div>
    </div>
    <div class="total-row"><span>–ò—Ç–æ–≥–æ</span><span id="total-val">0‚ÇΩ</span></div>
    <div class="delivery-free" id="delivery-free"></div>
    <input type="text" id="address" class="input-style" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏">
  </div>
  <button class="btn-main" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<!-- PROFILE SHEET -->
<div id="profile-sheet" class="sheet">
  <div class="sheet-handle"></div>
  <h2 style="margin:0 0 20px;font-weight:900;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
  <div class="sheet-scroll">
    <div class="profile-card">
      <img id="profile-avatar" class="profile-avatar-large" src="https://via.placeholder.com/100" alt="">
      <div class="profile-name" id="profile-name">‚Äî</div>
      <div class="profile-phone" id="profile-phone">‚Äî</div>
      <div class="profile-bonus-card">
        <div class="profile-bonus-label">–ë–æ–Ω—É—Å—ã</div>
        <div class="profile-bonus-val" id="profile-bonus">1 250 ‚ÇΩ</div>
      </div>
    </div>
    <div style="margin-bottom:20px;">
      <div style="font-size:14px;color:var(--text-gray);">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
      <input type="text" id="profile-address" class="input-style" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞">
    </div>
    <div style="margin-top:20px;">
      <div style="font-size:14px;color:var(--text-gray);">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
      <label class="theme-switch">
        <input type="checkbox" id="theme-toggle">
        <span class="slider"></span>
        <span class="labels">üåô</span>
      </label>
    </div>
  </div>
  <button class="btn-main" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<script>
/* ========== 0. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ========== */
document.addEventListener('DOMContentLoaded', () => {
  const tg = window.Telegram?.WebApp;
  if (!tg) {
    alert('–ó–∞–ø—É—Å—Ç–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á–µ—Ä–µ–∑ Telegram');
    return;
  }
  tg.expand();
  tg.ready();

  /* ========== 1. –î–∞–Ω–Ω—ã–µ ========== */
  let cart = [], curProd = null, payMethod = 'cash', currentTab = 'rolls';
  let promoApplied = false;
  let userData = { name:'‚Äî', phone:'‚Äî', address:'', bonus:1250 };

  const menu = {
    rolls: [
      {id:1,name:"–ú–µ—á—Ç–∞ –∫–æ—Ç–∞",price:1530,meta:"32 —à—Ç | 1.1 –∫–≥",img:"https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=600&random=1",desc:"–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è –æ–≥—É—Ä–µ—Ü, –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è –±–µ–∫–æ–Ω, –¢–µ–º–ø—É—Ä–∞ —á–∏–∫–µ–Ω, –¢–µ–º–ø—É—Ä–∞ —Ç–∞–º–∞–≥–æ –ª–æ—Å–æ—Å—å.",tag:"HOT",tagIcon:"üå∂Ô∏è"},
      {id:2,name:"–°–µ—Ç –ó–∏–º–Ω–∏–π",price:1945,meta:"64 —à—Ç | 2.2 –∫–≥",img:"https://images.unsplash.com/photo-1583623025817-d180a2221d0a?w=600&random=2",desc:"–û–≥—Ä–æ–º–Ω—ã–π —Å–µ—Ç –¥–ª—è –±–æ–ª—å—à–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.",tag:"NEW",tagIcon:"üî•"},
      {id:3,name:"–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è",price:650,meta:"8 —à—Ç | 280 –≥",img:"https://images.unsplash.com/photo-1553621042-f6e147245754?w=600&random=3",desc:"–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–æ–ª–ª —Å–æ —Å–≤–µ–∂–∏–º –ª–æ—Å–æ—Å–µ–º.",tag:"",tagIcon:""},
      {id:4,name:"–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è",price:590,meta:"8 —à—Ç | 250 –≥",img:"https://images.unsplash.com/photo-1559466273-d95e72debaf8?w=600&random=4",desc:"–°–Ω–µ–∂–Ω—ã–π –∫—Ä–∞–±, –æ–≥—É—Ä–µ—Ü –∏ –∏–∫—Ä–∞ —Ç–æ–±–∏–∫–æ.",tag:"",tagIcon:""}
    ],
    wok: [
      {id:5,name:"–ö—É—Ä–∏—Ü–∞ –≤–æ–∫",price:490,meta:"320 –≥",img:"https://images.unsplash.com/photo-1625938146369-adc83368bda7?w=600&random=5",desc:"–ö—É—Ä–∏—Ü–∞, –æ–≤–æ—â–∏, —Å–æ—É—Å —Ç–µ—Ä–∏—è–∫–∏.",tag:"",tagIcon:""},
      {id:6,name:"–ì–æ–≤—è–¥–∏–Ω–∞ –≤–æ–∫",price:590,meta:"320 –≥",img:"https://images.unsplash.com/photo-1625938146369-adc83368bda7?w=600&random=6",desc:"–ì–æ–≤—è–¥–∏–Ω–∞, –æ–≤–æ—â–∏, —Å–æ—É—Å —á–∏–ª–∏.",tag:"HOT",tagIcon:"üå∂Ô∏è"}
    ],
    snacks: [
      {id:7,name:"–ì–µ–¥–∑–∞",price:290,meta:"6 —à—Ç",img:"https://images.unsplash.com/photo-1617093727343-374698b1b08d?w=600&random=7",desc:"–ö—É—Ä–∏—Ü–∞, —Å–≤–∏–Ω–∏–Ω–∞, –æ–≤–æ—â–∏.",tag:"",tagIcon:""},
      {id:8,name:"–°–ø–∞–π—Å–∏ —ç–¥–∞–º–∞–º–µ",price:190,meta:"120 –≥",img:"https://images.unsplash.com/photo-1609501676725-7186f017a4b7?w=600&random=8",desc:"–û—Å—Ç—Ä—ã–π —Å–æ—É—Å, –∫—É–Ω–∂—É—Ç.",tag:"HOT",tagIcon:"üå∂Ô∏è"}
    ],
    drinks: [
      {id:9,name:"Coca-Cola",price:120,meta:"0.5 –ª",img:"https://images.unsplash.com/photo-1625772299848-391b6a87d281?w=600&random=9",desc:"–•–æ–ª–æ–¥–Ω–∞—è, –≥–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è.",tag:"",tagIcon:""},
      {id:10,name:"–§RESH-–ª–∏–º–æ–Ω–∞–¥",price:180,meta:"0.4 –ª",img:"https://images.unsplash.com/photo-1625772299848-391b6a87d281?w=600&random=10",desc:"–õ–∏–º–æ–Ω, –º—è—Ç–∞, –ª—ë–¥.",tag:"NEW",tagIcon:"üî•"}
    ]
  };

  const extras = [
    {id:'wasabi',name:'–í–∞—Å–∞–±–∏',price:30,icon:'üå∂Ô∏è'},
    {id:'sticks',name:'–ü–∞–ª–æ—á–∫–∏',price:40,icon:'ü•¢'},
    {id:'soya',name:'–°–æ–µ–≤—ã–π —Å–æ—É—Å',price:35,icon:'üßÇ'}
  ];

  const heroImages = [
    {img:"https://images.unsplash.com/photo-1553621042-f6e147245754?w=1200&random=101",txt:"–ü–æ–¥–∞—Ä–æ–∫ –∫ –∑–∞–∫–∞–∑—É –æ—Ç 2000‚ÇΩ"},
    {img:"https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=1200&random=102",txt:"–°–∫–∏–¥–∫–∞ -15% –Ω–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑"},
    {img:"https://images.unsplash.com/photo-1611143669185-af224c5e3252?w=1200&random=103",txt:"–ù–æ–≤—ã–π —Å–µ—Ç ¬´–°–∞–º—É—Ä–∞–π¬ª"}
  ];

  /* ========== 2. UI-—Ñ—É–Ω–∫—Ü–∏–∏ ========== */
  let heroIndex = 0;
  function initHeroSlider(){
    const slider = document.getElementById('hero-slider');
    slider.innerHTML = heroImages.map((h,i)=>`
      <div class="hero-slide ${i===0?'active':''}">
        <img src="${h.img}" alt=""><div class="hero-text">${h.txt}</div>
      </div>`).join('');
    setInterval(()=>{
      const slides = slider.querySelectorAll('.hero-slide');
      slides[heroIndex].classList.remove('active');
      heroIndex = (heroIndex + 1) % slides.length;
      slides[heroIndex].classList.add('active');
    }, 3000);
  }

  function switchTab(tab){
    currentTab = tab;
    document.querySelectorAll('.bottom-tab').forEach(t=>t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    render();
  }

  function render(){
    const grid = document.getElementById('grid');
    const items = menu[currentTab]||[];
    grid.innerHTML = items.map((p,i)=>`
      <div class="item" style="animation-delay:${i*0.1}s" onclick="showDetails(${p.id})">
        ${p.tag?`<div class="badge"><span class="badge-icon">${p.tagIcon}</span><span>${p.tag}</span></div>`:''}
        <img src="${p.img}" class="item-img">
        <div style="font-weight:800;font-size:15px">${p.name}</div>
        <div style="font-size:11px;color:var(--text-gray)">${p.meta}</div>
        <div class="price-row"><span class="p-val">${p.price}‚ÇΩ</span></div>
      </div>`).join('');
  }

  function showDetails(id){
    const item = Object.values(menu).flat().find(p=>p.id===id);
    if(!item)return;
    curProd = item;
    document.getElementById('d-img').src = item.img;
    document.getElementById('d-title').textContent = item.name || '';
    document.getElementById('d-meta').textContent = item.meta || '';
    document.getElementById('d-desc').textContent = item.desc || '';
    openSheet('details-sheet');
    tg.HapticFeedback.impactOccurred('medium');
  }

  function addToCartFromDetails(){
    const exist = cart.find(x=>x.id===curProd.id && !x.isExtra);
    if(exist) exist.qty = (exist.qty||1)+1;
    else cart.push({...curProd, qty:1});
    updateCartUI(); 
    showMiniCart();
    closeAll();
    tg.HapticFeedback.notificationOccurred('success');
  }

  function changeQty(id,delta){
    const item = cart.find(x=>x.id===id);
    if(!item)return;
    item.qty = Math.max(1, (item.qty||1)+delta);
    if(item.qty===0) cart=cart.filter(x=>x.id!==id);
    updateCartUI();
    if(cart.length===0) hideMiniCart();
  }

  function removeItem(id){ cart=cart.filter(x=>x.id!==id); updateCartUI(); if(cart.length===0) hideMiniCart();}

  function addExtra(id){
    const item = extras.find(e=>e.id===id);
    const exist = cart.find(x=>x.id===id && x.isExtra);
    if(exist) exist.qty = (exist.qty||1)+1;
    else cart.push({...item,qty:1,isExtra:true});
    updateCartUI();
    tg.HapticFeedback.impactOccurred('light');
  }

  function applyPromo(){
    const code = document.getElementById('promo-input').value.trim().toUpperCase();
    if(code==='YAKUZA'){
      promoApplied = true;
      tg.showAlert('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω! –î–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è.');
    }else{
      tg.showAlert('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    updateCartUI();
  }

  function updateCartUI(){
    const c=cart.reduce((s,i)=>s+(i.qty||1),0);
    document.getElementById('bals-val').innerText = userData.bonus.toLocaleString();

    const sub = cart.filter(i=>!i.isExtra).reduce((s,i)=>s+i.price*(i.qty||1),0);
    document.getElementById('mini-sum').innerText = sub+'‚ÇΩ';

    const extrasGrid = document.getElementById('extras-grid');
    extrasGrid.innerHTML = extras.map(e=>`
      <div class="extra-card" onclick="addExtra('${e.id}')">
        <div class="extra-icon">${e.icon}</div>
        <div>${e.name}</div>
        <div style="color:var(--accent-light);font-weight:700;">+${e.price}‚ÇΩ</div>
      </div>`).join('');

    let subtotal = cart.filter(i=>!i.isExtra).reduce((s,i)=>s+i.price*(i.qty||1),0);
    let extrasTotal = cart.filter(i=>i.isExtra).reduce((s,i)=>s+i.price*(i.qty||1),0);
    subtotal+=extrasTotal;

    const freeDeliveryThreshold = 900;
    let delivery = 0;
    if(!promoApplied && subtotal<freeDeliveryThreshold) delivery = 150;

    const total = subtotal+delivery;
    document.getElementById('total-val').innerText = total+'‚ÇΩ';

    const freeEl = document.getElementById('delivery-free');
    if(delivery===0) freeEl.innerText='–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞';
    else freeEl.innerText=`–î–æ—Å—Ç–∞–≤–∫–∞ 150‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç ${freeDeliveryThreshold}‚ÇΩ)`;

    document.getElementById('address').value = userData.address;

    const list=document.getElementById('cart-items');
    const mainItems = cart.filter(i=>!i.isExtra);
    if(mainItems.length===0){
      document.getElementById('cart-empty').style.display='block';
      list.innerHTML='';
    }else{
      document.getElementById('cart-empty').style.display='none';
      list.innerHTML=mainItems.map(i=>`
        <div class="cart-item">
          <div class="cart-info"><b>${i.name}</b><br><small>${i.price}‚ÇΩ</small></div>
          <div class="cart-controls">
            <button class="cart-btn" onclick="changeQty(${i.id},-1)">‚àí</button>
            <span class="cart-qty">${i.qty||1}</span>
            <button class="cart-btn" onclick="changeQty(${i.id},1)">+</button>
          </div>
          <span class="cart-price">${i.price*(i.qty||1)}‚ÇΩ</span>
          <span class="cart-remove" onclick="removeItem(${i.id})">–£–¥–∞–ª–∏—Ç—å</span>
        </div>`).join('');
    }
  }

  function setPay(m,el){ payMethod=m; document.querySelectorAll('.pay-opt').forEach(o=>o.classList.remove('active')); el.classList.add('active'); }

  function closeAll(){ document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('active')); document.getElementById('overlay').classList.remove('active'); }

  function openSheet(id){ document.getElementById(id).classList.add('active'); document.getElementById('overlay').classList.add('active'); }

  function openCart(){ openSheet('cart-sheet'); }
  function openProfile(){
    const user = tg.initDataUnsafe?.user;
    if(user){
      userData.name = user.first_name||'';
      userData.phone = user.username ? '@'+user.username : (user.id||'');
      if(user?.photo_url) {                               // –∑–∞—â–∏—Ç–∞ –æ—Ç null
        document.getElementById('user-avatar').src = user.photo_url + '?random=' + Date.now();
        document.getElementById('profile-avatar').src = user.photo_url + '?random=' + Date.now();
      }
    }
    document.getElementById('profile-name').textContent = userData.name;
    document.getElementById('profile-phone').textContent = userData.phone;
    document.getElementById('profile-bonus').textContent = userData.bonus.toLocaleString()+' ‚ÇΩ';
    document.getElementById('profile-address').value = userData.address;
    openSheet('profile-sheet');
  }

  function saveProfile(){
    userData.address = document.getElementById('profile-address').value;
    tg.showAlert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
    closeAll();
  }

  function sendOrder(){
    const mainItems = cart.filter(i=>!i.isExtra);
    if(mainItems.length===0) return;
    const addr = userData.address || document.getElementById('address').value.trim();
    if(!addr) return tg.showAlert("–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏!");
    tg.sendData(JSON.stringify({
      order:cart,
      address:addr,
      payment:payMethod,
      promo:promoApplied,
      total:document.getElementById('total-val').innerText,
      user:userData
    }));
    tg.showPopup({
      title: '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!',
      message: '–ú—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ –≥–æ—Ç–æ–≤–∏—Ç—å. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö.',
      buttons: [{type: 'ok', text: 'OK'}]
    });
    setTimeout(() => {
      tg.showPopup({
        title: '–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏',
        message: '–û–∂–∏–¥–∞–π—Ç–µ —á–µ—Ä–µ–∑ 25 –º–∏–Ω—É—Ç',
        buttons: [{type: 'ok', text: 'OK'}]
      });
    }, 15000);
  }

  function showMiniCart(){
    const mc = document.getElementById('mini-cart');
    mc.style.display='flex';
    mc.animate([{transform:'scale(0.8)',opacity:0},{transform:'scale(1)',opacity:1}],{duration:200,fill:'forwards'});
  }
  function hideMiniCart(){
    document.getElementById('mini-cart').style.display='none';
  }

  /* ========== 3. –ü–æ–∏—Å–∫ ========== */
  const searchIcon = document.getElementById('search-icon');
  const searchWrap = document.getElementById('search-wrap');
  const searchInput = document.getElementById('search-input');

  searchIcon.addEventListener('click', () => {
    searchWrap.classList.add('open');
    searchInput.focus();
  });
  searchInput.addEventListener('blur', () => {
    if (!searchInput.value) searchWrap.classList.remove('open');
  });
  searchInput.addEventListener('input', e => filterProducts(e.target.value.toLowerCase()));

  function filterProducts(q){
    const all = Object.values(menu).flat();
    const filtered = all.filter(p =>
      p.name.toLowerCase().includes(q) ||
      p.desc.toLowerCase().includes(q) ||
      (q.includes('–æ—Å—Ç—Ä–æ–µ') && p.tag==='HOT') ||
      (q.includes('–≤–µ–≥–∞–Ω') && p.desc.includes('–æ–≤–æ—â–∏'))
    );
    renderFiltered(filtered.length ? filtered : all);
  }
  function renderFiltered(list){
    document.getElementById('grid').innerHTML = list.map((p,i)=>`
      <div class="item" style="animation-delay:${i*0.1}s" onclick="showDetails(${p.id})">
        ${p.tag?`<div class="badge"><span class="badge-icon">${p.tagIcon}</span><span>${p.tag}</span></div>`:''}
        <img src="${p.img}" class="item-img">
        <div style="font-weight:800;font-size:15px">${p.name}</div>
        <div style="font-size:11px;color:var(--text-gray)">${p.meta}</div>
        <div class="price-row"><span class="p-val">${p.price}‚ÇΩ</span></div>
      </div>`).join('');
  }

  /* ========== 4. –¢–µ–º–∞ ========== */
  const themeToggle = document.getElementById('theme-toggle');
  themeToggle.addEventListener('change', () => {
    document.body.dataset.theme = themeToggle.checked ? 'dark' : 'light';
  });

  /* ========== 5. –°–≤–∞–π–ø-–∑–∞–∫—Ä—ã—Ç–∏–µ ========== */
  document.querySelectorAll('.sheet').forEach(sh=>{
    const h = new Hammer(sh);
    h.on('swipedown', closeAll);
  });

  /* ========== 6. –°—Ç–∞—Ä—Ç ========== */
  initHeroSlider();
  render();
  updateCartUI();
}); // end DOMContentLoaded
</script>
</body>
</html>