<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="cofe.styles.css">
    <title>Coffee Winter Art</title>
</head>
<body>
    <canvas id="mainCanvas"></canvas>

    <div class="header">
        <div class="logo-island">COFFEE <span>PRO</span></div>
        <div class="cart-btn" onclick="openCart()">
            <span id="cart-count">0</span>
            <i>üõçÔ∏è</i>
        </div>
    </div>

    <div class="container">
        <div class="welcome">
            <h1>–¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π<br><span>–∑–∏–º–Ω–∏–π –∫–æ—Ñ–µ</span></h1>
        </div>
        <div class="menu-grid" id="menu-grid"></div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>
    
    <div id="item-sheet" class="sheet">
        <div class="drag-handle"></div>
        <div class="image-box" id="image-box">
            <img id="item-img" src="" alt="">
            <canvas id="steamCanvas"></canvas>
        </div>

        <div class="sheet-content">
            <h2 id="item-title">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
            
            <div class="control-card">
                <div class="control-header">
                    <span>–•–æ–ª–æ–¥–Ω—ã–π ‚ùÑÔ∏è</span>
                    <b id="temp-label">80¬∞C</b>
                    <span>–ì–æ—Ä—è—á–∏–π üî•</span>
                </div>
                <input type="range" id="temp-input" min="0" max="100" value="80">
            </div>

            <div class="size-row">
                <div class="size-chip active" onclick="setSize(this)">–°—Ç–∞–Ω–¥–∞—Ä—Ç</div>
                <div class="size-chip" onclick="setSize(this)">–ë–æ–ª—å—à–æ–π</div>
            </div>

            <button class="add-to-cart-btn" onclick="buy(event)">
                –î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£ ‚Äî <span id="item-price">0</span>‚ÇΩ
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const products = [
            {id: 1, name: "–ö–∞–ø—É—á–∏–Ω–æ –ú–∞—Ä—à–º—ç–ª–ª–æ—É", price: 340, img: "https://images.unsplash.com/photo-1534778101976-62847782c213?w=500"},
            {id: 2, name: "–õ–∞—Ç—Ç–µ –°–æ–ª–µ–Ω–∞—è –ö–∞—Ä–∞–º–µ–ª—å", price: 390, img: "https://images.unsplash.com/photo-1541167760496-1628856ab772?w=500"},
            {id: 3, name: "–†–∞—Ñ –¶–∏—Ç—Ä—É—Å", price: 410, img: "https://images.unsplash.com/photo-1572442388796-11668a67e53d?w=500"}
        ];

        let cartCount = 0;
        const mainCanvas = document.getElementById('mainCanvas');
        const mctx = mainCanvas.getContext('2d');
        const steamCanvas = document.getElementById('steamCanvas');
        const sctx = steamCanvas.getContext('2d');
        
        let particles = [];
        let steamParticles = [];
        let isSheet = false;

        function resize() {
            mainCanvas.width = window.innerWidth;
            mainCanvas.height = window.innerHeight;
            steamCanvas.width = steamCanvas.parentElement.clientWidth;
            steamCanvas.height = steamCanvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Snowflake {
            constructor() {
                this.reset();
                this.y = Math.random() * mainCanvas.height;
            }
            reset() {
                this.x = Math.random() * mainCanvas.width;
                this.y = -20;
                this.size = Math.random() * 4 + 2;
                this.speed = Math.random() * 1 + 0.5;
                this.velX = Math.random() * 1 - 0.5;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotSpeed = Math.random() * 0.02 - 0.01;
            }
            update() {
                this.y += this.speed;
                this.x += this.velX;
                this.rotation += this.rotSpeed;
                if (this.y > mainCanvas.height) this.reset();
            }
            draw() {
                mctx.save();
                mctx.translate(this.x, this.y);
                mctx.rotate(this.rotation);
                mctx.strokeStyle = 'rgba(255,255,255,0.7)';
                mctx.lineWidth = 1;
                for(let i=0; i<6; i++) {
                    mctx.rotate(Math.PI/3);
                    mctx.beginPath();
                    mctx.moveTo(0,0);
                    mctx.lineTo(0, this.size);
                    mctx.stroke();
                }
                mctx.restore();
            }
        }

        class Steam {
            constructor(w, h) {
                this.w = w; this.h = h;
                this.reset();
            }
            reset() {
                this.x = Math.random() * this.w;
                this.y = this.h + 20;
                this.life = 1.0;
                this.size = Math.random() * 20 + 15;
                this.vx = Math.random() * 0.6 - 0.3;
                this.vy = Math.random() * -1.2 - 0.8;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 0.007;
                if(this.life <= 0) this.reset();
            }
            draw() {
                sctx.beginPath();
                let grad = sctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
                grad.addColorStop(0, `rgba(255,255,255,${this.life * 0.25})`);
                grad.addColorStop(1, 'rgba(255,255,255,0)');
                sctx.fillStyle = grad;
                sctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI*2);
                sctx.fill();
            }
        }

        const snowflakes = Array.from({length: 40}, () => new Snowflake());

        function loop() {
            mctx.clearRect(0,0, mainCanvas.width, mainCanvas.height);
            snowflakes.forEach(s => { s.update(); s.draw(); });

            if(isSheet) {
                sctx.clearRect(0,0, steamCanvas.width, steamCanvas.height);
                const t = document.getElementById('temp-input').value;
                if(t > 40) {
                    if(steamParticles.length < t/2) steamParticles.push(new Steam(steamCanvas.width, steamCanvas.height));
                    steamParticles.forEach(p => { p.update(); p.draw(); });
                } else {
                    steamParticles = [];
                }
            }
            requestAnimationFrame(loop);
        }
        loop();

        function render() {
            document.getElementById('menu-grid').innerHTML = products.map(p => `
                <div class="product-card" onclick="openItem(${p.id})">
                    <img src="${p.img}">
                    <div class="info">
                        <h3>${p.name}</h3>
                        <p>${p.price} ‚ÇΩ</p>
                    </div>
                </div>
            `).join('');
        }

        function openItem(id) {
            const p = products.find(x => x.id === id);
            document.getElementById('item-img').src = p.img;
            document.getElementById('item-title').innerText = p.name;
            document.getElementById('item-price').innerText = p.price;
            document.getElementById('item-sheet').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            isSheet = true;
            resize(); 
            tg.HapticFeedback.impactOccurred('medium');
        }

        function closeAll() {
            document.getElementById('item-sheet').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            isSheet = false;
        }

        document.getElementById('temp-input').oninput = function() {
            document.getElementById('temp-label').innerText = this.value + '¬∞C';
            tg.HapticFeedback.selectionChanged();
        }

        function buy(e) {
            cartCount++;
            document.getElementById('cart-count').innerText = cartCount;
            tg.HapticFeedback.notificationOccurred('success');
            setTimeout(closeAll, 300);
        }

        render();
    </script>
</body>
</html>